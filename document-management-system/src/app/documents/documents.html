<div class="p-6 max-w-5xl mx-auto">
  <h1 class="text-2xl font-semibold mb-4">Documents</h1>

  <form class="grid gap-4 md:grid-cols-4 items-start mb-6" (ngSubmit)="onUpload()" #f="ngForm">
    <div class="md:col-span-2">
      <label class="block text-sm mb-1">File</label>
      <div
        class="rounded-xl border-2 border-dashed border-gray-300 bg-white p-6 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50/40 transition"
        (click)="fileInput.click()"
        (dragover)="onDragOver($event)"
        (drop)="onDrop($event)"
        role="button"
        tabindex="0"
        (keydown.enter)="fileInput.click()"
        (keydown.space)="fileInput.click()"
      >
        <input #fileInput type="file" (change)="onFile($event)" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="sr-only" />
        <ng-container *ngIf="!file; else fileChosen">
          <div class="text-sm text-gray-600">
            <div class="font-medium text-gray-800">Click to upload</div>
            <div class="mt-1">or drag and drop here</div>
            <div class="mt-2 text-xs text-gray-500">PDF, DOC, DOCX, JPG, PNG — up to 25 MB</div>
          </div>
        </ng-container>
        <ng-template #fileChosen>
          <div class="flex flex-col items-center gap-2">
            <div class="text-sm font-medium text-gray-800 truncate max-w-full">{{ file?.name }}</div>
            <div class="text-xs text-gray-500">{{ file?.size | number }} bytes</div>
            <div class="flex gap-3 text-sm">
              <button type="button" class="text-indigo-600" (click)="fileInput.click()">Change</button>
              <button type="button" class="text-red-600" (click)="clearFile()">Remove</button>
            </div>
          </div>
        </ng-template>
      </div>
    </div>

    <div class="md:col-span-2 grid gap-3">
      <div>
        <label class="block text-sm mb-1">Title</label>
        <input name="title" [(ngModel)]="title" required class="w-full border rounded px-3 py-2" placeholder="Document title" />
      </div>
      <div>
        <label class="block text-sm mb-1">Description</label>
        <textarea name="description" [(ngModel)]="description" class="w-full border rounded px-3 py-2" rows="3" placeholder="Optional"></textarea>
      </div>
      <div>
        <label class="block text-sm mb-1">Category</label>
        <select name="category" [(ngModel)]="category" class="w-full border rounded px-3 py-2">
          <option value="">Select category</option>
          <option *ngFor="let c of categories" [value]="c">{{ c }}</option>
        </select>
      </div>
      <div>
        <button class="bg-indigo-600 text-white px-4 py-2 rounded disabled:opacity-50" [disabled]="!title || !file">Upload</button>
      </div>
    </div>
  </form>

  <div class="overflow-auto rounded-xl border bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-gray-600">
        <tr>
          <th class="text-left px-4 py-3">Title</th>
          <th class="text-left px-4 py-3">File name</th>
          <th class="text-left px-4 py-3">Category</th>
          <th class="text-right px-4 py-3">Size (KB)</th>
          <th class="text-left px-4 py-3">Uploaded</th>
          <th class="px-4 py-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of docs" class="border-t">
          <!-- Title -->
          <td class="px-4 py-2">
            <ng-container *ngIf="editingId !== d._id; else titleEdit">
              <div class="font-medium">{{ d.title }}</div>
            </ng-container>
            <ng-template #titleEdit>
              <div class="space-y-1">
                <input [(ngModel)]="editTitle" class="w-full border rounded px-2 py-1" placeholder="Title" />
                <input [(ngModel)]="editDescription" class="w-full border rounded px-2 py-1" placeholder="Description (optional)" />
              </div>
            </ng-template>
          </td>

          <!-- File name -->
          <td class="px-4 py-2 text-gray-600 truncate max-w-[280px]">{{ d.fileName }}</td>

          <!-- Category -->
          <td class="px-4 py-2">
            <ng-container *ngIf="editingId !== d._id; else catEdit">{{ d.category || '-' }}</ng-container>
            <ng-template #catEdit>
              <select [(ngModel)]="editCategory" class="border rounded px-2 py-1">
                <option value="">Select category</option>
                <option *ngFor="let c of categories" [value]="c">{{ c }}</option>
              </select>
            </ng-template>
          </td>

          <!-- Size -->
          <td class="px-4 py-2 text-right">{{ (d.size/1024) | number:'1.0-1' }} KB</td>

          <!-- Uploaded -->
          <td class="px-4 py-2">{{ d.createdAt | date:'medium' }}</td>

          <!-- Actions -->
          <td class="px-4 py-2">
            <ng-container *ngIf="editingId !== d._id; else actionsEdit">
              <div class="flex items-center gap-2">
                <button (click)="onView(d)" class="text-indigo-600 inline-flex items-center justify-center p-1 rounded hover:bg-indigo-50" title="View" aria-label="View">
                  <span [featherIcon]="'eye'" class="h-4 w-4"></span>
                </button>
                <button (click)="onDownload(d)" class="text-indigo-600 inline-flex items-center justify-center p-1 rounded hover:bg-indigo-50" title="Download" aria-label="Download">
                  <span [featherIcon]="'download'" class="h-4 w-4"></span>
                </button>
                <button (click)="startEdit(d)" class="text-gray-700 inline-flex items-center justify-center p-1 rounded hover:bg-gray-100" title="Edit" aria-label="Edit">
                  <span [featherIcon]="'edit-2'" class="h-4 w-4"></span>
                </button>
                <button (click)="onDelete(d)" class="text-red-600 inline-flex items-center justify-center p-1 rounded hover:bg-red-50" title="Delete" aria-label="Delete">
                  <span [featherIcon]="'trash'" class="h-4 w-4"></span>
                </button>
              </div>
            </ng-container>
            <ng-template #actionsEdit>
              <div class="flex flex-col gap-2">
                <input type="file" (change)="onEditFile($event)" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />
                <div class="flex items-center gap-2">
                  <button (click)="saveEdit(d)" class="bg-indigo-600 text-white px-3 py-1 rounded">Save</button>
                  <button (click)="cancelEdit()" class="px-3 py-1 rounded border">Cancel</button>
                </div>
              </div>
            </ng-template>
          </td>
        </tr>
        <tr *ngIf="docs.length === 0">
          <td colspan="6" class="px-4 py-6 text-center text-gray-500">No documents yet</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Preview modal -->
  <div *ngIf="previewDoc" class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" (click)="closePreview()"></div>
    <div class="relative bg-white rounded-lg shadow-xl w-[90vw] max-w-5xl max-h-[90vh] overflow-hidden">
      <div class="flex items-center justify-between border-b px-4 py-2">
        <div class="font-medium truncate">{{ previewDoc?.title }}</div>
        <button class="text-gray-600 hover:text-black" (click)="closePreview()">✕</button>
      </div>
      <div class="p-0">
        <div class="h-[80vh] w-[90vw] max-w-5xl flex items-center justify-center text-sm text-gray-600" *ngIf="!previewUrl">
          <span [featherIcon]="'loader'" class="h-4 w-4 animate-spin mr-2"></span>
          Loading preview...
        </div>
        <ng-container *ngIf="previewUrl">
          <ng-container *ngIf="previewDoc?.mimeType?.startsWith('image/'); else fileFrame">
            <img [src]="previewUrl" alt="preview" class="max-h-[80vh] w-auto mx-auto" />
          </ng-container>
          <ng-template #fileFrame>
            <iframe [attr.src]="previewUrl" class="w-[90vw] max-w-5xl h-[80vh]" frameborder="0"></iframe>
          </ng-template>
        </ng-container>
      </div>
    </div>
  </div>
</div>
