<div class="p-6 max-w-6xl mx-auto">
  <div class="flex flex-wrap gap-3 items-end mb-6">
    <div>
      <label class="block text-sm mb-1">Category</label>
      <select [(ngModel)]="category" class="border rounded px-3 py-2">
        <option value="">All categories</option>
        <option *ngFor="let c of categories" [value]="c">{{ c }}</option>
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">From</label>
      <input [(ngModel)]="from" type="date" class="border rounded px-3 py-2" />
    </div>
    <div>
      <label class="block text-sm mb-1">To</label>
      <input [(ngModel)]="to" type="date" class="border rounded px-3 py-2" />
    </div>
    <div class="flex gap-2">
      <button (click)="search()" class="bg-indigo-600 text-white px-4 py-2 rounded">Search</button>
      <button (click)="clear()" class="border px-4 py-2 rounded">Clear</button>
    </div>
  </div>
  <div *ngIf="anySelected" class="mb-3 p-3 rounded-lg border bg-amber-50 text-sm flex flex-wrap items-center gap-3">
    <div class="font-medium">Selected: {{ selected.size }}</div>
    <button class="px-3 py-1.5 rounded bg-red-600 text-white" (click)="bulkDelete()" [disabled]="loading">Delete</button>
    <div class="flex items-center gap-2">
      <label>Move to category:</label>
      <select class="border rounded px-2 py-1" [(ngModel)]="moveCategory">
        <option value="">Select category</option>
        <option *ngFor="let c of categories" [value]="c">{{ c }}</option>
      </select>
      <button class="px-3 py-1.5 rounded bg-indigo-600 text-white" (click)="bulkMove()" [disabled]="!moveCategory || loading">Move</button>
    </div>
  </div>


  <div *ngIf="loading" class="text-sm text-gray-600 mb-4">Loading...</div>

  <div class="overflow-auto rounded-xl border bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-gray-600">
        <tr>
          <th class="px-4 py-3 w-10">
            <input type="checkbox" [checked]="allOnPageSelected" (change)="toggleSelectAllOnPage($event.target.checked)" />
          </th>
          <th class="text-left px-4 py-3 cursor-pointer" (click)="sort('title')">
            Title
            <span class="ml-1 text-xs" *ngIf="sortBy==='title'">{{ sortDir==='asc' ? '▲' : '▼' }}</span>
          </th>
          <th class="text-left px-4 py-3">File name</th>
          <th class="text-left px-4 py-3 cursor-pointer" (click)="sort('category')">
            Category
            <span class="ml-1 text-xs" *ngIf="sortBy==='category'">{{ sortDir==='asc' ? '▲' : '▼' }}</span>
          </th>
          <th class="text-right px-4 py-3">Size (KB)</th>
          <th class="text-left px-4 py-3 cursor-pointer" (click)="sort('createdAt')">
            Uploaded
            <span class="ml-1 text-xs" *ngIf="sortBy==='createdAt'">{{ sortDir==='asc' ? '▲' : '▼' }}</span>
          </th>
          <th class="px-4 py-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of docs" class="border-t">
          <td class="px-4 py-2">
            <input type="checkbox" [checked]="selected.has(d._id)" (change)="toggleRow(d, $event.target.checked)" />
          </td>
          <td class="px-4 py-2 font-medium">{{ d.title }}</td>
          <td class="px-4 py-2 text-gray-600 truncate max-w-[280px]">{{ d.fileName }}</td>
          <td class="px-4 py-2">{{ d.category || '-' }}</td>
          <td class="px-4 py-2 text-right">{{ (d.size/1024) | number:'1.0-1' }} KB</td>
          <td class="px-4 py-2">{{ d.createdAt | date:'medium' }}</td>
          <td class="px-4 py-2">
            <div class="flex items-center gap-2">
              <button (click)="onView(d)" class="text-indigo-600 inline-flex items-center justify-center p-1 rounded hover:bg-indigo-50" title="View" aria-label="View">
                <span [featherIcon]="'eye'" class="h-4 w-4"></span>
              </button>
              <button (click)="onDownload(d)" class="text-indigo-600 inline-flex items-center justify-center p-1 rounded hover:bg-indigo-50" title="Download" aria-label="Download">
                <span [featherIcon]="'download'" class="h-4 w-4"></span>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="!loading && docs.length === 0">
          <td colspan="7" class="px-4 py-6 text-center text-gray-500">No documents found</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="mt-4 flex flex-wrap items-center justify-between gap-3 text-sm">
    <div>Page {{ page }} of {{ totalPages }} ({{ total | number }} total)</div>
    <div class="flex items-center gap-2">
      <label>Rows:</label>
      <select class="border rounded px-2 py-1" [ngModel]="limit" (ngModelChange)="changeLimit($event)">
        <option [ngValue]="10">10</option>
        <option [ngValue]="20">20</option>
        <option [ngValue]="50">50</option>
        <option [ngValue]="100">100</option>
      </select>
      <button class="border rounded px-3 py-1" (click)="prevPage()" [disabled]="page<=1">Prev</button>
      <button class="border rounded px-3 py-1" (click)="nextPage()" [disabled]="page>=totalPages">Next</button>
    </div>
  </div>



<!--

      <div class="text-xs text-gray-500">{{ d.mimeType }}  {{ d.size | number }} bytes</div>
-->



<!-- Preview modal -->
<div *ngIf="previewDoc" class="fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 bg-black/50" (click)="closePreview()"></div>
  <div class="relative bg-white rounded-lg shadow-xl w-[90vw] max-w-5xl max-h-[90vh] overflow-hidden">
    <div class="flex items-center justify-between border-b px-4 py-2">
      <div class="font-medium truncate">{{ previewDoc?.title }}</div>
      <button class="text-gray-600 hover:text-black" (click)="closePreview()">✕</button>
    </div>
    <div class="p-0">
      <div class="h-[80vh] w-[90vw] max-w-5xl flex items-center justify-center text-sm text-gray-600" *ngIf="!previewUrl">
        <span [featherIcon]="'loader'" class="h-4 w-4 animate-spin mr-2"></span>
        Loading preview...
      </div>
      <ng-container *ngIf="previewUrl">
        <ng-container *ngIf="previewDoc?.mimeType?.startsWith('image/'); else fileFrame">
          <img [src]="previewUrl" alt="preview" class="max-h-[80vh] w-auto mx-auto" />
        </ng-container>
        <ng-template #fileFrame>
          <iframe [src]="trustedPreviewUrl" class="w-[90vw] max-w-5xl h-[80vh]" frameborder="0"></iframe>
        </ng-template>
      </ng-container>
    </div>
  </div>
</div>



